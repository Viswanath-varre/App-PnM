{% extends 'user_base.html' %}
{% block title %}Edit Asset{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto p-4 sm:p-6 bg-white rounded shadow">
  <!-- Header -->
  <div class="flex flex-col sm:flex-row justify-between items-center mb-6">
    <h1 class="text-2xl font-bold mb-3 sm:mb-0">Edit Asset</h1>
    <a href="/user_asset_master" class="px-4 py-2 rounded border bg-gray-100 hover:bg-gray-200 text-sm">‚Üê Back to Asset Master</a>
  </div>

  <!-- Reference Info (readonly) -->
  <div class="bg-gray-50 border rounded p-4 mb-6">
    <h2 class="text-lg font-semibold mb-3">Asset Reference Info</h2>
    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-sm">
      <div>
        <label class="block text-gray-600">Asset Code</label>
        <div class="font-medium text-gray-800">{{ asset.asset_code }}</div>
      </div>
      <div>
        <label class="block text-gray-600">Description</label>
        <div class="font-medium text-gray-800">{{ asset.asset_description }}</div>
      </div>
      <div>
        <label class="block text-gray-600">Reg. No.</label>
        <div class="font-medium text-gray-800">{{ asset.reg_no }}</div>
      </div>
    </div>
  </div>

  <!-- Edit Form -->
  <form id="editAssetForm" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
    <input type="hidden" id="asset_id" value="{{ asset.id }}">

    <!-- Allowed fields only -->
    <div>
      <label class="block text-sm mb-1">Package</label>
      <input id="package" name="package" value="{{ asset.package }}" class="w-full border rounded px-3 py-2">
    </div>
    <div>
      <label class="block text-sm mb-1">Activity</label>
      <input id="activity" name="activity" value="{{ asset.activity }}" class="w-full border rounded px-3 py-2">
    </div>
    <div>
      <label class="block text-sm mb-1">Location</label>
      <input id="location" name="location" value="{{ asset.location }}" class="w-full border rounded px-3 py-2">
    </div>
    <div>
      <label class="block text-sm mb-1">Operators Available</label>
      <input id="operator_available" type="number" name="operator_available" value="{{ asset.operator_available }}" class="w-full border rounded px-3 py-2">
    </div>
    <div>
      <label class="block text-sm mb-1">Helpers Available</label>
      <input id="helper_available" type="number" name="helper_available" value="{{ asset.helper_available }}" class="w-full border rounded px-3 py-2">
    </div>
    <div>
      <label class="block text-sm mb-1">Supervisor/Owner Name</label>
      <input id="supervisor_owner_name" name="supervisor_owner_name" value="{{ asset.supervisor_owner_name }}" class="w-full border rounded px-3 py-2">
    </div>
    <div>
      <label class="block text-sm mb-1">Supervisor/Owner Phone</label>
      <input id="supervisor_owner_phone" name="supervisor_owner_phone" value="{{ asset.supervisor_owner_phone }}" class="w-full border rounded px-3 py-2">
    </div>
    <div>
      <label class="block text-sm mb-1">Operator 1</label>
      <input id="operator1" name="operator1" value="{{ asset.operator1 }}" class="w-full border rounded px-3 py-2">
    </div>
    <div>
      <label class="block text-sm mb-1">Operator 1 Phone</label>
      <input id="operator1_phone" name="operator1_phone" value="{{ asset.operator1_phone }}" class="w-full border rounded px-3 py-2">
    </div>
    <div>
      <label class="block text-sm mb-1">Operator 1 Shift</label>
      <input id="operator1_shift" name="operator1_shift" value="{{ asset.operator1_shift }}" class="w-full border rounded px-3 py-2">
    </div>
    <div>
      <label class="block text-sm mb-1">Operator 2</label>
      <input id="operator2" name="operator2" value="{{ asset.operator2 }}" class="w-full border rounded px-3 py-2">
    </div>
    <div>
      <label class="block text-sm mb-1">Operator 2 Phone</label>
      <input id="operator2_phone" name="operator2_phone" value="{{ asset.operator2_phone }}" class="w-full border rounded px-3 py-2">
    </div>
    <div>
      <label class="block text-sm mb-1">Operator 2 Shift</label>
      <input id="operator2_shift" name="operator2_shift" value="{{ asset.operator2_shift }}" class="w-full border rounded px-3 py-2">
    </div>

    <!-- Buttons -->
    <div class="col-span-1 sm:col-span-2 flex flex-col sm:flex-row justify-end gap-3 mt-6">
      <a href="/user_asset_master" class="px-4 py-3 rounded border text-center w-full sm:w-auto">Cancel</a>
      <button type="submit" class="px-4 py-3 rounded bg-green-600 text-white w-full sm:w-auto">Update</button>
    </div>
  </form>
</div>

<script>
  document.getElementById("editAssetForm").addEventListener("submit", async function(e){
    e.preventDefault();
    const id = document.getElementById("asset_id").value;

    const fields = [
      "package","activity","location",
      "operator_available","helper_available",
      "supervisor_owner_name","supervisor_owner_phone",
      "operator1","operator1_phone","operator1_shift",
      "operator2","operator2_phone","operator2_shift"
    ];

    const data = {};
    fields.forEach(f => {
      const el = document.getElementById(f);
      data[f] = el ? el.value : null;
    });

    data.last_updated_by = "{{ session.get('name','') }}";
    data.last_updated_at = new Date().toISOString();

    try {
      const r = await fetch(`/user_update_asset/${id}`, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(data)
      });
      const resp = await r.json();
      if(resp.success){
        window.location.href = "/user_asset_master";
      } else {
        alert("Update failed: " + (resp.error || "Unknown error"));
      }
    } catch(err){
      alert("Error: " + err);
    }
  });
</script>
{% endblock %}
