{% extends 'user_base.html' %}
{% block title %}User Asset Master{% endblock %}

{% block content %}
<style>
.user-asset-master {
  box-sizing: border-box;
  font-family: Arial, sans-serif;
  background-color: #f8f9fa;
  margin: 0;
  padding: 0;
}

.user-asset-master .container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 20px;
}

/* Page Header (fixed from "header" conflict) */
.user-asset-master .page-header {
  background: linear-gradient(135deg, #1f2937, #374151);
  color: #fbbf24;
  padding: 30px;
  border-radius: 10px;
  margin-bottom: 30px;
  box-shadow: 0 4px 15px rgba(31, 41, 55, 0.3);
}

.user-asset-master .page-header h1 {
  font-size: 28px;
  font-weight: bold;
  margin: 0 0 8px 0;
}

.user-asset-master .page-header p {
  font-size: 16px;
  margin: 0;
  opacity: 0.9;
}

/* Action Bar */
.user-asset-master .action-bar {
  background: white;
  padding: 20px;
  border-radius: 10px;
  margin-bottom: 30px;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
  display: flex;
  flex-wrap: wrap;
  gap: 15px;
  align-items: center;
  justify-content: space-between;
}

.user-asset-master .btn-group {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}

/* Buttons */
.user-asset-master .btn {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 12px 20px;
  border: none;
  border-radius: 6px;
  font-weight: 600;
  font-size: 14px;
  cursor: pointer;
  text-decoration: none;
  transition: all 0.2s ease;
}

.user-asset-master .btn-primary {
  background: #1f2937;
  color: #fbbf24;
}

.user-asset-master .btn-primary:hover {
  background: #111827;
  transform: translateY(-1px);
}

.user-asset-master .btn-success {
  background: #059669;
  color: white;
}

.user-asset-master .btn-success:hover {
  background: #047857;
  transform: translateY(-1px);
}

.user-asset-master .btn-info {
  background: #f59e0b;
  color: #1f2937;
}

.user-asset-master .btn-info:hover {
  background: #d97706;
  transform: translateY(-1px);
}

.user-asset-master .btn-secondary {
  background: #f3f4f6;
  color: #374151;
  border: 1px solid #d1d5db;
}

.user-asset-master .btn-secondary:hover {
  background: #e5e7eb;
  transform: translateY(-1px);
}

.user-asset-master .btn-filter {
  background: #f59e0b;
  color: #1f2937;
  padding: 12px;
}

.user-asset-master .btn-filter:hover {
  background: #d97706;
}

.user-asset-master .btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

/* ------------------- LOADING OVERLAY ------------------- */
.loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(255, 255, 255, 0.95);
  display: flex;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  z-index: 2000;
  transition: opacity 0.4s ease;
}

.loading-overlay.hidden {
  opacity: 0;
  pointer-events: none;
}

.loading-content {
  text-align: center;
  color: #374151;
}

.loading-text {
  margin-top: 18px;
  font-size: 1.2rem;
  font-weight: 600;
  color: #1f2937;
  animation: fadeText 2s infinite ease-in-out;
}

@keyframes fadeText {
  0%, 100% { opacity: 0.8; }
  50% { opacity: 1; }
}

/* Gear wheel animation */
.gear {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  border: 6px solid #fbbf24;
  border-top-color: transparent;
  border-right-color: transparent;
  animation: spinGear 1s linear infinite;
  box-shadow: 0 0 10px rgba(0,0,0,0.15);
}

@keyframes spinGear {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

/* Last Update Info */
.user-asset-master .last-update-info {
  text-align: right;
  font-size: 12px;
  color: #6b7280;
  margin-bottom: 15px;
  padding: 8px 15px;
  background: #f9fafb;
  border-radius: 6px;
  border: 1px solid #e5e7eb;
}

/* Search Panel */
.user-asset-master .search-panel {
  background: white;
  padding: 25px;
  border-radius: 10px;
  margin-bottom: 30px;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
  border: 1px solid #e5e7eb;
}

.user-asset-master .search-controls {
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
  align-items: center;
}

.user-asset-master .radio-group {
  display: flex;
  gap: 25px;
}

.user-asset-master .radio-item {
  display: flex;
  align-items: center;
  gap: 8px;
}

.user-asset-master .radio-item input[type="radio"] {
  width: 18px;
  height: 18px;
}

.user-asset-master .radio-item label {
  font-weight: 600;
  color: #374151;
  cursor: pointer;
}

.user-asset-master .search-input {
  flex: 1;
  min-width: 300px;
  padding: 12px 16px;
  border: 2px solid #d1d5db;
  border-radius: 8px;
  font-size: 16px;
}

.user-asset-master .search-input:focus {
  outline: none;
  border-color: #f59e0b;
  box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.1);
}

/* Table */
.user-asset-master .table-container {
  background: white;
  border-radius: 10px;
  overflow: hidden;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
  border: 2px solid #d1d5db;
}

/* Modal */
.user-asset-master .modal {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.6);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  padding: 20px;
}

.user-asset-master .modal.hidden {
  display: none;
}

.user-asset-master .modal-content {
  background: white;
  border-radius: 10px;
  width: 100%;
  max-width: 900px;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
}

.user-asset-master .modal-header {
  padding: 25px 30px 20px;
  border-bottom: 2px solid #e5e7eb;
}

.user-asset-master .modal-title {
  font-size: 24px;
  font-weight: bold;
  color: #374151;
  margin: 0;
}

.user-asset-master .modal-body {
  padding: 30px;
}

.user-asset-master .form-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
  gap: 25px;
}

.user-asset-master .form-group {
  display: flex;
  flex-direction: column;
}

.user-asset-master .form-label {
  font-weight: 600;
  color: #374151;
  margin-bottom: 8px;
  font-size: 14px;
}

.user-asset-master .form-input {
  padding: 12px 16px;
  border: 2px solid #d1d5db;
  border-radius: 8px;
  font-size: 16px;
}

.user-asset-master .form-input:focus {
  outline: none;
  border-color: #f59e0b;
  box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.1);
}

.user-asset-master .modal-footer {
  padding: 20px 30px 30px;
  display: flex;
  gap: 15px;
  justify-content: flex-end;
}

/* Tabulator Excel Style */
.user-asset-master .tabulator {
  border: 2px solid #d1d5db !important;
  font-family: Arial, sans-serif !important;
  font-size: 13px !important;
}

.user-asset-master .tabulator-header {
  background: #f8fafc !important;
  border-bottom: 2px solid #d1d5db !important;
}

.user-asset-master .tabulator-col {
  background: #f8fafc !important;
  border-right: 1px solid #d1d5db !important;
  text-align: center !important;
}

.user-asset-master .tabulator-col-title {
  font-weight: bold !important;
  color: #374151 !important;
  text-align: center !important;
  padding: 12px 8px !important;
}

.user-asset-master .tabulator-row {
  border-bottom: 1px solid #e5e7eb !important;
}

.user-asset-master .tabulator-cell {
  border-right: 1px solid #e5e7eb !important;
  text-align: center !important;
  padding: 10px 8px !important;
}

.user-asset-master .tabulator-row:nth-child(even) {
  background: #f9fafb !important;
}

.user-asset-master .tabulator-row:hover {
  background: #e0f2fe !important;
}

.user-asset-master .tabulator-selected {
  background: #dbeafe !important;
}

/* Responsive */
@media (max-width: 768px) {
  .user-asset-master .container {
    padding: 15px;
  }
  
  .user-asset-master .page-header {
    padding: 20px;
    text-align: center;
  }
  
  .user-asset-master .page-header h1 {
    font-size: 24px;
  }
  
  .user-asset-master .locations-row {
    grid-template-columns: 1fr;
  }
  
  .user-asset-master .action-bar {
    flex-direction: column;
    align-items: stretch;
  }
  
  .user-asset-master .btn-group {
    justify-content: center;
  }
  
  .user-asset-master .search-controls {
    flex-direction: column;
    align-items: stretch;
  }
  
  .user-asset-master .search-input {
    min-width: auto;
  }
  
  .user-asset-master .form-grid {
    grid-template-columns: 1fr;
  }
}

/* Ensure rows and selection checkboxes are clickable */
.user-asset-master .tabulator-row,
.user-asset-master .tabulator-cell {
  cursor: pointer !important;
}

  /* ----- User Dashboard Glow Layout ----- */
  .dashboard {
    max-width: 1200px;
    margin: 0 auto;
    padding: 1rem 1.5rem;
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .last-update-header {
    text-align: right;
    margin-bottom: 0.5rem;
  }

  .total-assets-card {
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    border: 2px solid #3b82f6;
    border-radius: 10px;
    padding: 1rem;
    box-shadow: 0 0 15px rgba(59, 130, 246, 0.3);
    transition: all 0.3s ease;
  }

  .total-assets-card:hover {
    box-shadow: 0 0 25px rgba(59, 130, 246, 0.6);
    transform: translateY(-4px);
  }

  .locations-row {
    display: flex;
    justify-content: space-between;
    gap: 1rem;
    flex-wrap: wrap;
  }

  .card {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 10px;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
    padding: 0.75rem;
    flex: 1;
    min-width: 320px;
    transition: all 0.3s ease;
  }

  .card:hover {
    box-shadow: 0 0 18px rgba(37, 99, 235, 0.3);
    transform: translateY(-3px);
  }

  .stats-new-layout {
    display: flex;
    align-items: flex-start;
    justify-content: space-around;
    gap: 0.75rem;
    flex-wrap: nowrap;
  }

  .stat-column {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    min-width: 100px;
    flex: 1;
  }

  .stat-main {
    background: #f9fafb;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 0.5rem;
    text-align: center;
    transition: all 0.3s ease;
  }

  .stat-sub {
    background: #f3f4f6;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    padding: 0.4rem;
    text-align: center;
    transition: all 0.3s ease;
  }

  .stat-main:hover, .stat-sub:hover {
    box-shadow: 0 0 10px rgba(56, 189, 248, 0.3);
    transform: scale(1.03);
  }

  .nc-box {
    background: #f9fafb;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 0.5rem;
    min-width: 70px;
    text-align: center;
    align-self: flex-start;
    transition: all 0.3s ease;
  }

  .nc-box:hover {
    box-shadow: 0 0 10px rgba(168, 85, 247, 0.4);
    transform: scale(1.05);
  }

  .stat-label {
    font-size: 0.75rem;
    font-weight: 600;
    color: #6b7280;
    margin-bottom: 0.25rem;
  }

  .stat-number {
    font-size: 1rem;
    font-weight: 700;
  }

  .stat-number.own { color: #dc2626; }
  .stat-number.hire { color: #ea580c; }
  .stat-number.nc { color: #7c3aed; }
  .text-blue-700 { color: #1d4ed8; }
  .text-green-700 { color: #15803d; }


</style>

<div class="user-asset-master">
  <div class="container">

  <!-- Header -->
  <div class="page-header">
    <h1>Asset Master</h1>
    
  </div>


  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay">
    <div class="loading-content">
      <div class="gear"></div>
      <div class="loading-text">Hold tight, getting your details…</div>
    </div>
  </div>

  <!-- Dashboard -->
  <div class="dashboard">

    <!-- Last Update -->
    <div class="last-update-header">
      <div id="lastUpdate" class="text-xs text-gray-600">Last Update: --</div>
    </div>

    <!-- Total Assets -->
    <div class="card total-assets-card">
      <h3 class="card-title">Total Assets</h3>
      <div class="stats-new-layout">
        <div class="stat-column">
          <div class="stat-main">
            <div class="stat-label">Own</div>
            <div id="countOwn" class="stat-number own">0</div>
          </div>
          <div class="stat-sub">
            <div class="stat-label">IHC (₹ Cr)</div>
            <div id="totalIHC" class="stat-number text-green-700">₹ 0 Cr</div>
          </div>
        </div>
        <div class="stat-column">
          <div class="stat-main">
            <div class="stat-label">Hire</div>
            <div id="countHire" class="stat-number hire">0</div>
          </div>
          <div class="stat-sub">
            <div class="stat-label">EHC (₹ Cr)</div>
            <div id="totalEHC" class="stat-number text-blue-700">₹ 0 Cr</div>
          </div>
        </div>
        <div class="nc-box">
          <div class="stat-label">NC</div>
          <div id="countNC" class="stat-number nc">0</div>
        </div>
      </div>
    </div>

    <!-- Locations -->
    <div class="locations-row">

      <!-- Adabari -->
      <div class="card">
        <h3 class="card-title">Adabari</h3>
        <div class="stats-new-layout">
          <div class="stat-column">
            <div class="stat-main">
              <div class="stat-label">Own</div>
              <div id="adabariOwn" class="stat-number own">0</div>
            </div>
            <div class="stat-sub">
              <div class="stat-label">IHC (₹ Cr)</div>
              <div id="adabariIHC" class="stat-number text-green-700">₹ 0 Cr</div>
            </div>
          </div>
          <div class="stat-column">
            <div class="stat-main">
              <div class="stat-label">Hire</div>
              <div id="adabariHire" class="stat-number hire">0</div>
            </div>
            <div class="stat-sub">
              <div class="stat-label">EHC (₹ Cr)</div>
              <div id="adabariEHC" class="stat-number text-blue-700">₹ 0 Cr</div>
            </div>
          </div>
          <div class="nc-box">
            <div class="stat-label">NC</div>
            <div id="adabariNC" class="stat-number nc">0</div>
          </div>
        </div>
      </div>

      <!-- Birsing -->
      <div class="card">
        <h3 class="card-title">Birsing</h3>
        <div class="stats-new-layout">
          <div class="stat-column">
            <div class="stat-main">
              <div class="stat-label">Own</div>
              <div id="birsingOwn" class="stat-number own">0</div>
            </div>
            <div class="stat-sub">
              <div class="stat-label">IHC (₹ Cr)</div>
              <div id="birsingIHC" class="stat-number text-green-700">₹ 0 Cr</div>
            </div>
          </div>
          <div class="stat-column">
            <div class="stat-main">
              <div class="stat-label">Hire</div>
              <div id="birsingHire" class="stat-number hire">0</div>
            </div>
            <div class="stat-sub">
              <div class="stat-label">EHC (₹ Cr)</div>
              <div id="birsingEHC" class="stat-number text-blue-700">₹ 0 Cr</div>
            </div>
          </div>
          <div class="nc-box">
            <div class="stat-label">NC</div>
            <div id="birsingNC" class="stat-number nc">0</div>
          </div>
        </div>
      </div>

      <!-- Phulbari -->
      <div class="card">
        <h3 class="card-title">Phulbari</h3>
        <div class="stats-new-layout">
          <div class="stat-column">
            <div class="stat-main">
              <div class="stat-label">Own</div>
              <div id="phulbariOwn" class="stat-number own">0</div>
            </div>
            <div class="stat-sub">
              <div class="stat-label">IHC (₹ Cr)</div>
              <div id="phulbariIHC" class="stat-number text-green-700">₹ 0 Cr</div>
            </div>
          </div>
          <div class="stat-column">
            <div class="stat-main">
              <div class="stat-label">Hire</div>
              <div id="phulbariHire" class="stat-number hire">0</div>
            </div>
            <div class="stat-sub">
              <div class="stat-label">EHC (₹ Cr)</div>
              <div id="phulbariEHC" class="stat-number text-blue-700">₹ 0 Cr</div>
            </div>
          </div>
          <div class="nc-box">
            <div class="stat-label">NC</div>
            <div id="phulbariNC" class="stat-number nc">0</div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Action Bar -->
  <div class="action-bar">

    
    <div class="btn-group">
      <button id="refreshBtn" class="btn btn-secondary">Refresh</button>
      <button id="downloadExcelBtn" class="btn btn-success">Download Excel</button>
      <button id="downloadCsvBtn" class="btn btn-info">Download CSV</button>
    </div>
  </div>

  <!-- Search Panel -->
  <div class="search-panel">
    <div class="search-controls">
      <div class="radio-group">
        <div class="radio-item">
          <input type="radio" id="searchAssetCode" name="searchMode" value="asset_code" checked>
          <label for="searchAssetCode">By Asset Code</label>
        </div>
        <div class="radio-item">
          <input type="radio" id="searchRegNo" name="searchMode" value="reg_no">
          <label for="searchRegNo">By Registration No.</label>
        </div>
      </div>
      
      <input id="globalSearchInput" placeholder="Search assets..." class="search-input" />
      <button id="clearSearchBtn" class="btn btn-secondary">Clear</button>
    </div>
  </div>

  <!-- Table -->
  <div class="table-container">
    <div id="scrollTop" style="overflow-x: auto;"><div style="height:1px"></div></div>
    <div id="asset-table"></div>
    <div id="scrollBottom" style="overflow-x: auto;"><div style="height:1px"></div></div>
  </div>
</div>


<!-- Tabulator & Excel Export Support -->
<link href="https://unpkg.com/tabulator-tables@5.5.0/dist/css/tabulator.min.css" rel="stylesheet">

<!-- SheetJS library for Excel export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>


<!-- Tabulator -->
<link href="https://unpkg.com/tabulator-tables@5.5.0/dist/css/tabulator.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://unpkg.com/tabulator-tables@5.5.0/dist/js/tabulator.min.js"></script>

<script>
  const columns = [
    { title: "Sl. No.", formatter: "rownum", hozAlign: "center", width: 80 },
    { title: "Asset Code", field: "asset_code", headerFilter: "input", hozAlign: "center" },
    { title: "Asset Description", field: "asset_description", headerFilter: "input", hozAlign: "center" },

    {
      title: "Asset Category",
      field: "asset_category",
      headerFilter: "input",
      hozAlign: "center"
    },
   
    {
      title: "Reg. No.",
      field: "reg_no",
      headerFilter: "input",
      hozAlign: "center"
    },
    {
      title: "Package",
      field: "package",
      editor: "list",
      editorParams: {
        values: ["Adabari", "Birsing", "Phulbari"]
      },
      headerFilter: "input",
      hozAlign: "center"
    },
    {
      title: "Activity",
      field: "activity",
      editor: "list",
      editorParams: {
        values: [
          "Batching Plant",
          "LG",
          "Fabrication",
          "Civil Works",
          "Upper Pylon",
          "Bridge Builders",
          "Pire Table",
          "Marine",
          "Well Works",
          "Office / Accommodation / Admin",
          "Enabling",
          "Other Works"
        ]
      },
      headerFilter: "input",
      hozAlign: "center"
    },
    {
      title: "Activity Works",
      field: "activity_works",
      editor: "input",
      headerFilter: "input", 
      hozAlign: "center"
    },  
    {
      title: "Location",
      field: "location",
      editor: "input",
      headerFilter: "input",
      hozAlign: "center"
    },
    {
      title: "Meter Type",
      field: "meter_type",
      headerFilter: "input",
      hozAlign: "center"
    },
    {
      title: "UoM",
      field: "uom",
      headerFilter: "input",
      hozAlign: "center"
    },
    {
      title: "Fuel Norms",
      field: "fuel_norms",
      headerFilter: "input",
      hozAlign: "center"
    },
    {
      title: "Owner",
      field: "owner",
      headerFilter: "input",
      hozAlign: "center"
    },
    { title: "Vendor Code", field: "vendor_code", headerFilter: "input", hozAlign: "center" },
    { title: "Agency", field: "agency", headerFilter: "input", hozAlign: "center" },
    { title: "WOD Number", field: "wod_number", headerFilter: "input", hozAlign: "center" },
    { title: "Vendor Mail Id", field: "vendor_mail_id", headerFilter: "input", hozAlign: "center" },
    { title: "Date of Commission", field: "date_of_commission", headerFilter: "input", hozAlign: "center" },
    { title: "Starting Reading", field: "starting_reading", hozAlign: "center" },
    { title: "Tank Capacity", field: "tank_capacity", hozAlign: "center" },
    { title: "HSD Available", field: "hsd_available", hozAlign: "center" },
    { title: "Make", field: "make", headerFilter: "input", hozAlign: "center" },
    { title: "Model", field: "model", headerFilter: "input", hozAlign: "center" },
    { title: "PM Make", field: "pm_make", headerFilter: "input", hozAlign: "center" },
    { title: "PM Model", field: "pm_model", headerFilter: "input", hozAlign: "center" },
    { title: "EHC", field: "ehc", hozAlign: "center" },
    { title: "IHC", field: "ihc", hozAlign: "center" },
    { title: "Shift Hours", field: "shift_hours", hozAlign: "center" },
    { title: "Operators Avail", field: "operator_available", headerFilter: "input", hozAlign: "center" },
    { title: "Helpers Avail", field: "helper_available", headerFilter: "input", hozAlign: "center" },
    { title: "Supervisor/Owner Name", field: "supervisor_owner_name", headerFilter: "input", hozAlign: "center" },
    { title: "Supervisor/Owner Phone", field: "supervisor_owner_phone", headerFilter: "input", hozAlign: "center" },
    { title: "Operator 1", field: "operator1", headerFilter: "input", hozAlign: "center" },
    { title: "Op1 Phone", field: "operator1_phone", headerFilter: "input", hozAlign: "center" },
    { title: "Op1 Shift", field: "operator1_shift", editor: "list", editorParams:{values:["Day","Night"]}, headerFilter: "input", hozAlign: "center" },
    { title: "Operator 2", field: "operator2", headerFilter: "input", hozAlign: "center" },
    { title: "Op2 Phone", field: "operator2_phone", headerFilter: "input", hozAlign: "center" },
    { title: "Op2 Shift", field: "operator2_shift", editor: "list", editorParams:{values:["Day","Night"]}, headerFilter: "input", hozAlign: "center" },
    { title: "Last Updated By", field: "last_updated_by", hozAlign: "center" },
    { title: "Last Updated At", field: "last_updated_at", hozAlign: "center" },

    {
      title: "Actions",
      width: 140,
      hozAlign: "center",
      formatter: (cell) => {
        const id = cell.getRow().getData().id;
        return `<a href="/user/edit_asset/${id}" class="btn btn-info" style="padding: 6px 12px; font-size: 12px; text-decoration: none;">Edit</a>`;
      }
    }
  ];

  const table = new Tabulator("#asset-table", {
    height: "500px",
    layout: "fitDataStretch",
    columns: columns,
    ajaxURL: "/user/get_assets",
    index: "id",
    placeholder: "No Data Available",

    // ✅ Always sort naturally by Asset Code (01, 1, 02, 2, 03, 3)
    initialSort: [{ column: "asset_code", dir: "asc" }],
    sortMode: "local",
    columnDefaults: { headerSort: false },  // optional: lock header sorting

    sorters: {
      asset_code: function(a, b) {
        const valA = String(a || "").trim();
        const valB = String(b || "").trim();

        // extract numeric parts
        const numA = parseInt(valA.replace(/\D/g, "")) || 0;
        const numB = parseInt(valB.replace(/\D/g, "")) || 0;

        // if numbers differ, compare numerically
        if (numA !== numB) return numA - numB;

        // otherwise, fall back to normal string comparison
        return valA.localeCompare(valB, undefined, { numeric: true });
      }
    }
  });

  // ✅ Catch inline cell edits globally and sync with Supabase
  table.on("cellEdited", async function(cell) {
    const row = cell.getRow().getData();
    const field = cell.getField();
    const value = cell.getValue();

    try {
      const res = await fetch(`/user/update_asset/${row.id}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ [field]: value })
      });

      const text = await res.text();
      let result;
      try {
        result = JSON.parse(text);
      } catch {
        console.error("Non-JSON response:", text);
        showToast("⚠️ Session expired or server error. Please log in again.");
        return;
      }

      if (result.success) {
        console.log(`✅ Inline updated '${field}' for ID ${row.id}`);
        updateOwnerCounts();
        showToast("✅ Saved Successfully");
      } else {
        console.warn("⚠️ Supabase update failed:", result.error);
        showToast("⚠️ Failed to update");
      }
    } catch (err) {
      console.error("❌ Error saving inline:", err);
      showToast("❌ Error saving");
    }
  });

  // Show loading overlay at start
  const loader = document.getElementById("loadingOverlay");
  loader.classList.remove("hidden");

  // ✅ Trigger after Tabulator has fully loaded and parsed data
  table.on("dataLoaded", function(data) {
    if (loader) loader.classList.add("hidden");

    if (Array.isArray(data) && data.length > 0) {
      updateOwnerCounts();
    } else {
      console.warn("⚠️ No data available yet for dashboard counts.");
      setTimeout(() => {
        const allData = table.getData("all");
        if (Array.isArray(allData) && allData.length > 0) {
          updateOwnerCounts();
          if (loader) loader.classList.add("hidden");
        }
      }, 2000);
    }
  });

  // ✅ Optional: re-run counts every time data is refreshed
  table.on("dataProcessed", function() {
    updateOwnerCounts();
    if (loader) loader.classList.add("hidden");
  });

  // Load Data
  function loadData() {
    table.replaceData("/user/get_assets");
  }

  // 💰 Helper: Convert numeric value to ₹ Crore format
  function toCrore(value) {
    if (!value || isNaN(value)) return "₹ 0 Cr";
    const crore = value / 10000000; // 1 Crore = 10,000,000
    return "₹ " + crore.toFixed(2) + " Cr";
  }

  // ✅ Update Counts (Own, Hire, NC + EHC, IHC)
  function updateOwnerCounts() {
    const data = table.getData("all");
    let own = 0, hire = 0, nc = 0;
    let totalEHC = 0, totalIHC = 0;

    const packages = {
      "adabari": { own: 0, hire: 0, nc: 0, ehc: 0, ihc: 0 },
      "birsing": { own: 0, hire: 0, nc: 0, ehc: 0, ihc: 0 },
      "phulbari": { own: 0, hire: 0, nc: 0, ehc: 0, ihc: 0 }
    };

    data.forEach(r => {
      const o = (r.owner || "").toLowerCase();
      const pkg = (r.package || "").trim().toLowerCase();
      const ehc = parseFloat(r.ehc) || 0;
      const ihc = parseFloat(r.ihc) || 0;

      // Count owner types
      if (o === "own") own++;
      else if (o === "hire") hire++;
      else if (o === "nc") nc++;

      // Accumulate totals
      totalEHC += ehc;
      totalIHC += ihc;

      // Per-package totals
      if (packages[pkg]) {
        if (o === "own") packages[pkg].own++;
        else if (o === "hire") packages[pkg].hire++;
        else if (o === "nc") packages[pkg].nc++;
        packages[pkg].ehc += ehc;
        packages[pkg].ihc += ihc;
      }
    });

    // ✅ Update total dashboard
    document.getElementById("countOwn").innerText = own;
    document.getElementById("countHire").innerText = hire;
    document.getElementById("countNC").innerText = nc;
    document.getElementById("totalEHC").innerText = toCrore(totalEHC);
    document.getElementById("totalIHC").innerText = toCrore(totalIHC);

    // ✅ Update each package dashboard
    ["adabari", "birsing", "phulbari"].forEach(p => {
      document.getElementById(`${p}Own`).innerText = packages[p].own;
      document.getElementById(`${p}Hire`).innerText = packages[p].hire;
      document.getElementById(`${p}NC`).innerText = packages[p].nc;
      document.getElementById(`${p}EHC`).innerText = toCrore(packages[p].ehc);
      document.getElementById(`${p}IHC`).innerText = toCrore(packages[p].ihc);
    });

    // ✅ Last Update Timestamp
    const latest = data.reduce((acc, r) => {
      if (r.last_updated_at && (!acc || new Date(r.last_updated_at) > new Date(acc)))
        return r.last_updated_at;
      return acc;
    }, null);

    let formatted = latest;
    if (latest && !isNaN(Date.parse(latest))) {
      formatted = new Date(latest).toLocaleString();
    }
    document.getElementById("lastUpdate").innerText = formatted || "No updates yet";
  }

  // Helper: Generate filename for downloads
  function getFileName(baseName, ext) {
    const now = new Date();
    const yyyy = now.getFullYear();
    const mm = String(now.getMonth() + 1).padStart(2, "0");
    const dd = String(now.getDate()).padStart(2, "0");
    const hh = String(now.getHours()).padStart(2, "0");
    const min = String(now.getMinutes()).padStart(2, "0");
    const ss = String(now.getSeconds()).padStart(2, "0");
    return `${baseName}_${yyyy}-${mm}-${dd}_${hh}-${min}-${ss}.${ext}`;
  }

  // Excel download - All rows with styling + correct Sl.No. in column A
  document.getElementById("downloadExcelBtn").addEventListener("click", ()=>{
    const filename = getFileName("Asset_Master", "xlsx");
    table.download("xlsx", filename, {
      sheetName: "Assets",
      rowRange: "all",
      documentProcessing: function(workbook){
        const worksheet = workbook.Sheets["Assets"];
        if(!worksheet || !worksheet["!ref"]) return workbook;

        const range = XLSX.utils.decode_range(worksheet["!ref"]);
        const headerRow = range.s.r;

        // find "Sl. No." column
        let slCol = null;
        for(let C = range.s.c; C <= range.e.c; ++C){
          const headerAddr = XLSX.utils.encode_cell({r: headerRow, c: C});
          const headerCell = worksheet[headerAddr];
          const txt = headerCell && headerCell.v ? String(headerCell.v).trim().toLowerCase() : "";
          if(txt.startsWith("sl")) { slCol = C; break; }
        }
        if(slCol === null) slCol = range.s.c;

        const headerStyle = {
          font: {bold: true, color: {rgb: "FFFFFF"}},
          fill: {fgColor: {rgb: "1F2937"}},
          alignment: {horizontal: "center", vertical: "center"},
          border: {top:{style:"thin"},bottom:{style:"thin"},left:{style:"thin"},right:{style:"thin"}}
        };

        const cellStyle = {
          alignment: {horizontal: "center", vertical: "center"},
          border: {top:{style:"thin"},bottom:{style:"thin"},left:{style:"thin"},right:{style:"thin"}}
        };

        // style header
        for(let C = range.s.c; C <= range.e.c; ++C){
          const headerAddr = XLSX.utils.encode_cell({r: headerRow, c: C});
          if(worksheet[headerAddr]) worksheet[headerAddr].s = headerStyle;
        }

        // fill Sl.No and style data
        for(let R = headerRow + 1; R <= range.e.r; ++R){
          for(let C = range.s.c; C <= range.e.c; ++C){
            const addr = XLSX.utils.encode_cell({r: R, c: C});
            if(!worksheet[addr]) worksheet[addr] = { t: 's', v: "" };
            if(C === slCol){
              worksheet[addr].v = R - headerRow;
              worksheet[addr].t = 'n';
            }
            worksheet[addr].s = cellStyle;
          }
        }

        return workbook;
      }
    });
  });

  // CSV download - manual with Sl.No. in column A
  document.getElementById("downloadCsvBtn").addEventListener("click", ()=>{
    const data = table.getData("all");
    const filename = getFileName("Asset_Master", "csv");
    const headers = [
        "Sl. No.","Asset Code","Asset Description","Asset Category","Reg. No.","Package","Activity","Activity Works","Location",
        "Meter Type","UoM","Fuel Norms","Owner","Vendor Code","Agency","WOD Number",
        "Vendor Mail Id","Date of Commission","Starting Reading","Tank Capacity","HSD Available",
        "Make","Model","PM Make","PM Model","EHC","Add. Op Charge","Shift Hours",
        "Operators Avail","Helpers Avail","Supervisor/Owner Name","Supervisor/Owner Phone",
        "Operator 1","Op1 Phone","Op1 Shift","Operator 2","Op2 Phone","Op2 Shift",
        "Last Updated By","Last Updated At"
    ];

    const rows = [];
    rows.push(headers.join(","));
    data.forEach((r, idx) => {
        const rowArr = [
            idx + 1,
            r.asset_code || "",
            r.asset_description || "",
            r.asset_category || "",
            r.reg_no || "",
            r.package || "",
            r.activity || "",
            r.activity_works || "",
            r.location || "",
            r.meter_type || "",
            r.uom || "",
            r.fuel_norms || "",
            r.owner || "",
            r.vendor_code || "",
            r.agency || "",
            r.wod_number || "",
            r.vendor_mail_id || "",
            r.date_of_commission || "",
            r.starting_reading || "",
            r.tank_capacity || "",
            r.hsd_available || "",
            r.make || "",
            r.model || "",
            r.pm_make || "",
            r.pm_model || "",
            r.ehc || "",
            r.ihc || "",
            r.shift_hours || "",
            r.operator_available || "",
            r.helper_available || "",
            r.supervisor_owner_name || "",
            r.supervisor_owner_phone || "",
            r.operator1 || "",
            r.operator1_phone || "",
            r.operator1_shift || "",
            r.operator2 || "",
            r.operator2_phone || "",
            r.operator2_shift || "",
            r.last_updated_by || "",
            r.last_updated_at || ""
        ];
        rows.push(rowArr.map(v => `"${String(v).replace(/"/g,'""')}"`).join(","));
    });

    const csvContent = "data:text/csv;charset=utf-8," + rows.join("\n");
    const link = document.createElement("a");
    link.setAttribute("href", encodeURI(csvContent));
    link.setAttribute("download", filename);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  });

    // Small floating "Saved ✅" popup
  function showToast(message) {
    const toast = document.createElement("div");
    toast.textContent = message;
    toast.style.position = "fixed";
    toast.style.bottom = "20px";
    toast.style.right = "20px";
    toast.style.background = "#16a34a";
    toast.style.color = "white";
    toast.style.padding = "10px 20px";
    toast.style.borderRadius = "8px";
    toast.style.boxShadow = "0 4px 8px rgba(0,0,0,0.3)";
    toast.style.fontSize = "14px";
    toast.style.zIndex = 9999;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 2000);
  }
  
  // ✅ Immediately load when script runs (since script is at the end)
  loadData();

  // ✅ Also attach refresh button

  document.getElementById("refreshBtn").addEventListener("click", loadData);

</script>


{% endblock %}
