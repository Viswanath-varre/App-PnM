{% extends 'admin_base.html' %}
{% block title %}Admin Asset Master{% endblock %}

{% block content %}
<div class="p-4">

  <!-- Title + Buttons -->
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-4 gap-3">
    <div>
      <h1 class="text-2xl font-bold">Asset Master (Admin)</h1>
      <p class="text-sm text-gray-600">Manage all asset master records</p>
    </div>

    <div class="flex flex-wrap items-center gap-2">
      <!-- Funnel Icon -->
      <button id="toggleFiltersBtn" class="p-2 rounded border" title="Toggle Filters">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 01.8 1.6L13 10v5a1 1 0 01-1.447.894l-2-1A1 1 0 019 14v-4L3.2 4.6A1 1 0 013 4z" clip-rule="evenodd"/>
        </svg>
      </button>
      


      <a href="/admin/admin_add_asset" class="px-3 py-2 rounded bg-yellow-custom text-black">Add Asset</a>
      <a href="/admin/download_assets_csv" class="px-3 py-2 rounded border">Download CSV</a>
      <a href="/admin/download_assets_template_csv" class="px-3 py-2 rounded border">Download Template CSV</a>
      <a href="#" id="downloadExcelBtn" class="px-3 py-2 rounded border">Download Excel</a>

      <label class="px-3 py-2 rounded border cursor-pointer bg-white">
        Upload CSV
        <input id="csvUploadInput" type="file" accept=".csv" style="display:none" />
      </label>

      <button id="refreshBtn" class="px-3 py-2 rounded border">Refresh</button>
      <button id="deleteSelectedBtn" class="px-3 py-2 rounded border bg-red-500 text-white">Delete Selected</button>
    </div>
  </div>

  <!-- Upload progress/status -->
  <div id="uploadWrapper" class="mt-2 hidden">
    <div class="h-2 bg-gray-200 rounded relative">
      <div id="uploadProgress" class="h-2 bg-green-500 rounded w-0 text-xs text-white text-center"></div>
    </div>
    <div id="uploadStatus" class="text-xs text-gray-500 mt-1"></div>
  </div>

  <!-- Dashboard -->
  <div class="dashboard">

    <!-- Last Update -->
    <div class="last-update-header">
      <div id="lastUpdate" class="text-xs text-gray-600">Last Update: --</div>
    </div>

    <!-- Total Assets -->
    <div class="card total-assets-card">
      <h3 class="card-title">Total Assets</h3>
      <div class="stats-new-layout">
        <div class="stat-column">
          <div class="stat-main">
            <div class="stat-label">Own</div>
            <div id="countOwn" class="stat-number own">0</div>
          </div>
          <div class="stat-sub">
            <div class="stat-label">IHC (₹ Cr)</div>
            <div id="totalIHC" class="stat-number text-green-700">₹ 0 Cr</div>
          </div>
        </div>
        <div class="stat-column">
          <div class="stat-main">
            <div class="stat-label">Hire</div>
            <div id="countHire" class="stat-number hire">0</div>
          </div>
          <div class="stat-sub">
            <div class="stat-label">EHC (₹ Cr)</div>
            <div id="totalEHC" class="stat-number text-blue-700">₹ 0 Cr</div>
          </div>
        </div>
        <div class="nc-box">
          <div class="stat-label">NC</div>
          <div id="countNC" class="stat-number nc">0</div>
        </div>
      </div>
    </div>

    <!-- Locations -->
    <div class="locations-row">

      <!-- Adabari -->
      <div class="card">
        <h3 class="card-title">Adabari</h3>
        <div class="stats-new-layout">
          <div class="stat-column">
            <div class="stat-main">
              <div class="stat-label">Own</div>
              <div id="adabariOwn" class="stat-number own">0</div>
            </div>
            <div class="stat-sub">
              <div class="stat-label">IHC (₹ Cr)</div>
              <div id="adabariIHC" class="stat-number text-green-700">₹ 0 Cr</div>
            </div>
          </div>
          <div class="stat-column">
            <div class="stat-main">
              <div class="stat-label">Hire</div>
              <div id="adabariHire" class="stat-number hire">0</div>
            </div>
            <div class="stat-sub">
              <div class="stat-label">EHC (₹ Cr)</div>
              <div id="adabariEHC" class="stat-number text-blue-700">₹ 0 Cr</div>
            </div>
          </div>
          <div class="nc-box">
            <div class="stat-label">NC</div>
            <div id="adabariNC" class="stat-number nc">0</div>
          </div>
        </div>
      </div>

      <!-- Birsing -->
      <div class="card">
        <h3 class="card-title">Birsing</h3>
        <div class="stats-new-layout">
          <div class="stat-column">
            <div class="stat-main">
              <div class="stat-label">Own</div>
              <div id="birsingOwn" class="stat-number own">0</div>
            </div>
            <div class="stat-sub">
              <div class="stat-label">IHC (₹ Cr)</div>
              <div id="birsingIHC" class="stat-number text-green-700">₹ 0 Cr</div>
            </div>
          </div>
          <div class="stat-column">
            <div class="stat-main">
              <div class="stat-label">Hire</div>
              <div id="birsingHire" class="stat-number hire">0</div>
            </div>
            <div class="stat-sub">
              <div class="stat-label">EHC (₹ Cr)</div>
              <div id="birsingEHC" class="stat-number text-blue-700">₹ 0 Cr</div>
            </div>
          </div>
          <div class="nc-box">
            <div class="stat-label">NC</div>
            <div id="birsingNC" class="stat-number nc">0</div>
          </div>
        </div>
      </div>

      <!-- Phulbari -->
      <div class="card">
        <h3 class="card-title">Phulbari</h3>
        <div class="stats-new-layout">
          <div class="stat-column">
            <div class="stat-main">
              <div class="stat-label">Own</div>
              <div id="phulbariOwn" class="stat-number own">0</div>
            </div>
            <div class="stat-sub">
              <div class="stat-label">IHC (₹ Cr)</div>
              <div id="phulbariIHC" class="stat-number text-green-700">₹ 0 Cr</div>
            </div>
          </div>
          <div class="stat-column">
            <div class="stat-main">
              <div class="stat-label">Hire</div>
              <div id="phulbariHire" class="stat-number hire">0</div>
            </div>
            <div class="stat-sub">
              <div class="stat-label">EHC (₹ Cr)</div>
              <div id="phulbariEHC" class="stat-number text-blue-700">₹ 0 Cr</div>
            </div>
          </div>
          <div class="nc-box">
            <div class="stat-label">NC</div>
            <div id="phulbariNC" class="stat-number nc">0</div>
          </div>
        </div>
      </div>

    </div>
  </div>
  <!-- Search -->
  <div class="flex flex-col sm:flex-row items-center gap-2 mb-3">
    <div class="flex items-center gap-2"><input type="radio" id="searchAssetCode" name="searchMode" value="asset_code" checked><label for="searchAssetCode" class="text-sm">By Asset Code</label></div>
    <div class="flex items-center gap-2"><input type="radio" id="searchRegNo" name="searchMode" value="reg_no"><label for="searchRegNo" class="text-sm">By Reg. No.</label></div>
    <input id="globalSearchInput" placeholder="Type to search..." class="flex-1 px-3 py-2 border rounded" />
    <button id="clearSearchBtn" class="px-3 py-2 rounded border">Clear</button>
  </div>

  <!-- Top Scrollbar -->
  <div id="scrollTop" class="overflow-x-auto mb-1"><div style="height:1px"></div></div>
  <div id="asset-table" class="overflow-x-auto"></div>
  <div id="scrollBottom" class="overflow-x-auto mt-1"><div style="height:1px"></div></div>
</div>

<!-- Error Popup -->
<div id="errorPopup" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center z-50">
  <div class="bg-white rounded shadow-lg w-96 max-h-96 overflow-y-auto p-4">
    <h3 class="text-lg font-bold text-red-600 mb-2">Upload Errors</h3>
    <ul id="errorList" class="list-disc pl-5 text-sm text-gray-700"></ul>
    <div class="text-right mt-4 space-x-2">
      <button id="downloadErrorCsv" class="px-3 py-1 bg-gray-600 text-white rounded">Download Errors</button>
      <button id="closeErrorPopup" class="px-3 py-1 bg-red-500 text-white rounded">Close</button>
    </div>
  </div>
</div>


<!-- ✅ Toast Notification Box -->
<div id="toast" class="fixed bottom-5 right-5 hidden z-50 rounded-lg px-4 py-3 text-white shadow-lg transition-all duration-500 transform">
  <span id="toastMsg" class="text-sm"></span>
</div>

<!-- ✅ Loading Overlay (animated gear) -->
<div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 hidden z-40 flex items-center justify-center">
  <div class="flex flex-col items-center space-y-3">
    <svg xmlns="http://www.w3.org/2000/svg" class="animate-spin h-12 w-12 text-yellow-400" fill="none" viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
      <path class="opacity-75" fill="currentColor"
        d="M4 12a8 8 0 018-8v4l3-3-3-3v4a8 8 0 00-8 8h4z"></path>
    </svg>
    <p class="text-white font-semibold text-lg animate-pulse">Uploading...</p>
  </div>
</div>

<!-- Tabulator -->
<link href="https://unpkg.com/tabulator-tables@5.5.0/dist/css/tabulator.min.css" rel="stylesheet">
<script src="https://unpkg.com/tabulator-tables@5.5.0/dist/js/tabulator.min.js"></script>

<!-- ✅ Add XLSX dependency for Excel download -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
  #asset-table .tabulator .tabulator-header .tabulator-col .tabulator-header-filter { display: none; }
  #asset-table.filters-visible .tabulator .tabulator-header .tabulator-col .tabulator-header-filter { display: block !important; }
  #uploadProgress { text-align: center; font-size: 10px; color: white; }
</style>

<style>
  /* ---------------- Base Layout ---------------- */
  body {
    box-sizing: border-box;
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    background: #f8f9fa;
    background-image: 
      radial-gradient(circle at 25px 25px, #e9ecef 2px, transparent 2px),
      radial-gradient(circle at 75px 75px, #dee2e6 1px, transparent 1px);
    background-size: 100px 100px;
    min-height: 100%;
  }

  html, body {
    height: 100%;
  }

  /* ---------------- Dashboard Layout ---------------- */
  .dashboard {
    max-width: 1200px;
    margin: 0 auto;
    padding: 1rem 1.5rem;
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .last-update-header {
    text-align: right;
    margin-bottom: 0.5rem;
  }

  /* Top Total Assets Box */
  .total-assets-card {
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    border: 2px solid #3b82f6;
    border-radius: 10px;
    padding: 1rem;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
  }

  .card-title {
    font-size: 1rem;
    font-weight: 700;
    color: #1f2937;
    text-align: center;
    margin-bottom: 0.75rem;
  }

  /* Horizontal Location Row */
  .locations-row {
    display: flex;
    justify-content: space-between;
    gap: 1rem;
    flex-wrap: wrap;
  }

  /* Card Base Style */
  .card {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 10px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    padding: 0.75rem;
    flex: 1;
    min-width: 320px;
  }

  .card h3 {
    font-size: 0.9rem;
    font-weight: 700;
    text-align: center;
    color: #1f2937;
    margin-bottom: 0.5rem;
  }

  /* ---------------- Stat Box Layout ---------------- */
  .stats-new-layout {
    display: flex;
    align-items: flex-start;
    justify-content: space-around;
    gap: 0.75rem;
    flex-wrap: nowrap;
  }

  .stat-column {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    min-width: 100px;
    flex: 1;
  }

  .stat-main {
    background: #f9fafb;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 0.5rem;
    text-align: center;
  }

  .stat-sub {
    background: #f3f4f6;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    padding: 0.4rem;
    text-align: center;
  }

  .nc-box {
    background: #f9fafb;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 0.5rem;
    min-width: 70px;
    text-align: center;
    align-self: flex-start;
  }

  .stat-label {
    font-size: 0.75rem;
    font-weight: 600;
    color: #6b7280;
    margin-bottom: 0.25rem;
  }

  .stat-number {
    font-size: 1rem;
    font-weight: 700;
  }

  /* ---------------- Colors ---------------- */
  .stat-number.own {
    color: #dc2626; /* red */
  }

  .stat-number.hire {
    color: #ea580c; /* orange */
  }

  .stat-number.nc {
    color: #7c3aed; /* violet */
  }

  .text-blue-700 {
    color: #1d4ed8;
  }

  .text-green-700 {
    color: #15803d;
  }

  /* ---------------- Responsive Design ---------------- */
  @media (max-width: 1024px) {
    .locations-row {
      flex-wrap: wrap;
      justify-content: center;
      gap: 0.75rem;
    }
  }

  @media (max-width: 768px) {
    .dashboard {
      padding: 0.75rem;
    }

    .card {
      min-width: 100%;
    }

    .stats-new-layout {
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .stat-column {
      min-width: 45%;
    }

    .nc-box {
      min-width: 60px;
    }

    .card-title {
      font-size: 0.85rem;
    }

    .stat-label {
      font-size: 0.7rem;
    }

    .stat-number {
      font-size: 0.9rem;
    }
  }

  @media (max-width: 480px) {
    .locations-row {
      flex-direction: column;
      gap: 0.75rem;
    }

    .card {
      min-width: 100%;
    }

    .stat-column {
      min-width: 100%;
    }

    .stats-new-layout {
      flex-wrap: wrap;
    }
  }

  /* ---------------- Toast Notification ---------------- */
  #toast.success {
    background-color: #16a34a; /* green */
  }

  #toast.error {
    background-color: #dc2626; /* red */
  }

  #toast.show {
    display: block;
    opacity: 1;
    transform: translateY(0);
  }

  #toast.hide {
    opacity: 0;
    transform: translateY(20px);
  }

</style>

 
<script>

  /* ------------------ Helpers (one copy only) ------------------ */
  function showToast(message, type = "success", duration = 3000) {
    const toast = document.getElementById("toast");
    const msg = document.getElementById("toastMsg");
    if (!toast || !msg) return;

    // Set classes
    toast.classList.remove("success", "error");
    toast.classList.add(type);
    msg.textContent = message;

    // Show
    toast.style.display = "block";
    toast.style.opacity = "1";
    toast.style.transform = "translateY(0)";

    // Auto-hide
    setTimeout(() => {
      toast.style.opacity = "0";
      toast.style.transform = "translateY(20px)";
      setTimeout(() => {
        toast.style.display = "none";
      }, 500);
    }, duration);
  }

  function showLoading(show = true) {
    const overlay = document.getElementById("loadingOverlay");
    if (!overlay) return;
    if (show) overlay.classList.remove("hidden");
    else overlay.classList.add("hidden");
  }

  function formatLocalDate(dateStr) {
    if (!dateStr) return "--";
    const date = new Date(dateStr);
    if (isNaN(date)) return "--";
    const opts = {
      day: "2-digit",
      month: "2-digit",
      year: "numeric",
      hour: "2-digit",
      minute: "2-digit",
      second: "2-digit",
      hour12: true
    };
    return date.toLocaleString("en-IN", opts).replace(",", "");
  }
  /* ---------------- end helpers ---------------- */


  const columns = [
    {formatter:"rowSelection", titleFormatter:"rowSelection", hozAlign:"center", headerSort:false, width:50, cellClick:function(e, cell){ cell.getRow().toggleSelect(); }},
    {title:"ID", field:"id", width:70, hozAlign:"left"},
    {title:"Sl. No.", formatter:"rownum", hozAlign:"center", width:80},
    {title:"Asset Code", field:"asset_code", editor:"input", headerFilter:"input", frozen:true},
    {title:"Asset Description", field:"asset_description", editor:"input", headerFilter:"input"},
    {
        title: "Asset Category",
        field: "asset_category",
        editor: "list",
        editorParams: {
            values: [
                "Concreting Eqpt",
                "Cranes",
                "Marine Eqpt",
                "Earthmoving Eqpt",
                "Material Handling Eqpt",
                "Power Generators",
                "Utility Eqpt",
                "Vehicles - Cargo",
                "Vehicles - Passenger"
            ]
        },
        headerFilter: "select",
        headerFilterParams: {
            values: {
                "": "All",
                "Concreting Eqpt": "Concreting Eqpt",
                "Cranes": "Cranes",
                "Marine Eqpt": "Marine Eqpt",
                "Earthmoving Eqpt": "Earthmoving Eqpt",
                "Material Handling Eqpt": "Material Handling Eqpt",
                "Power Generators": "Power Generators",
                "Utility Eqpt": "Utility Eqpt",
                "Vehicles - Cargo": "Vehicles - Cargo",
                "Vehicles - Passenger": "Vehicles - Passenger"
            }
        }
    },
    {
        title: "Reg. No.",
        field: "reg_no",
        editor: "input",
        headerFilter: "input"
    },
    {
        title: "Package",
        field: "package",
        editor: "list",
        editorParams: {
            values: ["Adabari", "Birsing", "Phulbari"]
        },
        headerFilter: "select",
        headerFilterParams: {
            values: {
                "": "All",
                "Adabari": "Adabari",
                "Birsing": "Birsing",
                "Phulbari": "Phulbari"
            }
        }
    },
    {
        title: "Activity",
        field: "activity",
        editor: "list",
        editorParams: {
            values: [
                "Batching Plant",
                "LG",
                "Fabrication",
                "Civil Works",
                "Bridge Builders",
                "Pire Table",
                "Upper Pylon",
                "Marine",
                "Well Works",
                "Office / Accommodation / Admin",
                "Enabling",
                "Other Works"
            ]
        },
        headerFilter: "select",
        headerFilterParams: {
            values: {
                "": "All",
                "Batching Plant": "Batching Plant",
                "LG": "LG",
                "Upper Pylon": "Upper Pylon",
                "Fabrication": "Fabrication",
                "Civil Works": "Civil Works",
                "Bridge Builders": "Bridge Builders",
                "Pire Table": "Pire Table",
                "Marine": "Marine",
                "Well Works": "Well Works",
                "Office / Accommodation / Admin": "Office / Accommodation / Admin",
                "Enabling": "Enabling",
                "Other Works": "Other Works"
            }
        }
    },
    {
        title: "Activity Works",
        field: "activity_works", 
        editor: "input",  
        headerFilter: "input", 
        hozAlign: "center"
    },
    {
        title: "Location",
        field: "location",
        editor: "input",
        headerFilter: "input"
    },
    {
        title: "Meter Type",
        field: "meter_type",
        editor: "list",
        editorParams: {
            values: ["HMR", "KMR", "HMR/KMR"]
        },
        headerFilter: "select",
        headerFilterParams: {
            values: {
                "": "All",
                "HMR": "HMR",
                "KMR": "KMR",
                "HMR/KMR": "HMR/KMR"
            }
        }
    },
    {
        title: "UoM",
        field: "uom",
        editor: "list",
        editorParams: {
            values: ["KMPL", "LPH", "LPH/KMPL"]
        },
        headerFilter: "select",
        headerFilterParams: {
            values: {
                "": "All",
                "KMPL": "KMPL",
                "LPH": "LPH",
                "LPH/KMPL": "LPH/KMPL"
            }
        }
    },
    {
        title: "Fuel Norms",
        field: "fuel_norms",
        editor: "input",
        headerFilter: "input"
    },
    {
        title: "Owner",
        field: "owner",
        editor: "list",
        editorParams: {
            values: ["Own", "Hire", "NC"]
        },
        headerFilter: "select",
        headerFilterParams: {
            values: {
                "": "All",
                "Own": "Own",
                "Hire": "Hire",
                "NC": "NC"
            }
        }
    },
    {title:"Vendor Code", field:"vendor_code", editor:"input", headerFilter:"input"},
    {title:"Agency", field:"agency", editor:"input", headerFilter:"input"},
    {title:"WOD Number", field:"wod_number", editor:"input", headerFilter:"input"},
    {title:"Vendor Mail Id", field:"vendor_mail_id", editor:"input", headerFilter:"input"},
    {title:"Date of Commission", field:"date_of_commission", editor:"input", headerFilter:"input"},
    {title:"Starting Reading", field:"starting_reading", editor:"number", headerFilter:"input"},
    {title:"Tank Capacity", field:"tank_capacity", editor:"number", headerFilter:"input"},
    {title:"HSD Available", field:"hsd_available", editor:"number", headerFilter:"input"},
    {title:"Make", field:"make", editor:"input", headerFilter:"input"},
    {title:"Model", field:"model", editor:"input", headerFilter:"input"},
    {title:"PM Make", field:"pm_make", editor:"input", headerFilter:"input"},
    {title:"PM Model", field:"pm_model", editor:"input", headerFilter:"input"},
    {title:"EHC", field:"ehc", editor:"number", headerFilter:"input"},
    {title:"IHC", field:"ihc", editor:"number", headerFilter:"input"},
    {title:"Shift Hours", field:"shift_hours", editor:"number", headerFilter:"input"},
    {title:"Operators Avail", field:"operator_available", editor:"number", headerFilter:"input"},
    {title:"Helpers Avail", field:"helper_available", editor:"number", headerFilter:"input"},
    {title:"Supervisor/Owner Name", field:"supervisor_owner_name", editor:"input", headerFilter:"input"},
    {title:"Supervisor/Owner Phone", field:"supervisor_owner_phone", editor:"input", headerFilter:"input"},
    {title:"Operator 1", field:"operator1", editor:"input", headerFilter:"input"},
    {title:"Op1 Phone", field:"operator1_phone", editor:"input", headerFilter:"input"},
    {title:"Op1 Shift", field:"operator1_shift", editor:"input", headerFilter:"input"},
    {title:"Operator 2", field:"operator2", editor:"input", headerFilter:"input"},
    {title:"Op2 Phone", field:"operator2_phone", editor:"input", headerFilter:"input"},
    {title:"Op2 Shift", field:"operator2_shift", editor:"input", headerFilter:"input"},
    {title:"Last Updated By", field:"last_updated_by"},
    {title:"Last Updated At", field:"last_updated_at"},
      {
        title: "Actions",
        width: 160,
        hozAlign: "center",
        formatter: (cell) => {
          const id = cell.getRow().getData().id;
          return `
            <a href="/admin/admin_edit_asset/${id}" class="editRowLink px-2 py-1 bg-blue-500 text-white rounded text-xs">Edit</a>
            <button class="deleteRowBtn px-2 py-1 bg-red-500 text-white rounded text-xs">Delete</button>
          `;
        },
        cellClick: (e, cell) => {
          const target = e.target;
          const id = cell.getRow().getData().id;

          // 🟥 Handle Delete
          if (target.classList.contains("deleteRowBtn")) {
            e.preventDefault();
            if (confirm("Delete this asset?")) {
              fetch(`/admin/delete_asset/${id}`, { method: "DELETE" })
                .then((r) => r.json())
                .then((resp) => {
                  if (resp.success) {
                    cell.getRow().delete();
                    updateOwnerCounts();
                    showToast("Deleted successfully", "success");
                  } else {
                    showToast("Delete failed: " + (resp.error || "Unknown"), "error");
                  }
                })
                .catch((err) => showToast("Delete error: " + err, "error"));
            }
          }
          // 🟩 Edit link will work normally → no preventDefault
        },
      }
  ];



    const table = new Tabulator("#asset-table", {
    height: "500px",
    layout: "fitDataStretch",
    columns: columns,
    ajaxURL: "/admin/get_assets",
    index: "id",
    placeholder: "No Data",
    selectable: true,

    // ✅ Natural order sort by asset_code (01, 1, 02, 2, etc.)
    initialSort: [{ column: "asset_code", dir: "asc" }],
    sortMode: "local",
    columnDefaults: { headerSort: false },  // optional - disable header re-sorting

    // ✅ Custom sorter to mix numeric + text properly
    sorters: {
      asset_code: function(a, b, aRow, bRow, column, dir, sorterParams) {
        // Remove non-digits just in case
        const valA = String(a || "").trim();
        const valB = String(b || "").trim();

        // Try to parse numeric part
        const numA = parseInt(valA.replace(/\D/g, "")) || 0;
        const numB = parseInt(valB.replace(/\D/g, "")) || 0;

        // If numeric parts differ, sort by number
        if (numA !== numB) return numA - numB;

        // Otherwise, fallback to lexicographic (to handle 01 vs 1)
        return valA.localeCompare(valB, undefined, { numeric: true });
      }
    }
  });


 

  table.on("cellEdited", function(cell) {
    console.log(">>> cellEdited fired for ID:", cell.getRow().getData().id);

    const data = cell.getRow().getData();
    const allowed = [
      "asset_code","asset_description","asset_category","reg_no","package","activity",
      "location","meter_type","uom","fuel_norms","owner","vendor_code","agency",
      "wod_number","vendor_mail_id","date_of_commission","starting_reading","tank_capacity",
      "hsd_available","make","model","pm_make","pm_model","ehc",
      "ihc","shift_hours","operator_available","helper_available",
      "supervisor_owner_name","supervisor_owner_phone","operator1","operator1_phone",
      "operator1_shift","operator2","operator2_phone","operator2_shift"
    ];

    const payload = {};
    allowed.forEach(k => {
      if (data.hasOwnProperty(k)) payload[k] = data[k];
    });

    payload.last_updated_by = "{{ session.get('name','') }}";
    payload.last_updated_at = new Date().toISOString();

    fetch(`/admin/update_asset/${data.id}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
    })
    .then(async r => {
        const text = await r.text();
        let resp;
        try { 
            resp = JSON.parse(text); 
        } catch {
            console.error("Non-JSON response:", text);
            alert("⚠️ Server returned HTML or unexpected data. Try logging in again.");
            return;
        }

        if (resp.success) {
            showToast("Saved Successfully ✅", "success");
        } else {
            showToast("Update failed: " + (resp.error || "Unknown error"), "error");
        }
    })
    .catch(err => showToast("Error while saving: " + err, "error"));
  });  // ✅ Properly closed here


  // Load Data
  function loadData(){
    table.replaceData("/admin/get_assets").then(updateOwnerCounts);
  }

  // 💰 Update counts + EHC/IHC totals + last update
    function updateOwnerCounts() {
    const data = table.getData() || [];
    let own = 0, hire = 0, nc = 0;
    let totalEHC = 0, totalIHC = 0;

    // Lowercase package keys to handle inconsistent data
    const packages = {
      adabari: { own: 0, hire: 0, nc: 0, ehc: 0, ihc: 0 },
      birsing:  { own: 0, hire: 0, nc: 0, ehc: 0, ihc: 0 },
      phulbari: { own: 0, hire: 0, nc: 0, ehc: 0, ihc: 0 }
    };

    data.forEach(r => {
      const o = (r.owner || "").toString().trim().toLowerCase();
      const pkg = (r.package || "").toString().trim().toLowerCase();
      const ehc = parseFloat(r.ehc) || 0;
      const ihc = parseFloat(r.ihc) || 0;

      if (o === "own") own++;
      else if (o === "hire") hire++;
      else if (o === "nc") nc++;

      totalEHC += ehc;
      totalIHC += ihc;

      if (packages[pkg]) {
        if (o === "own") packages[pkg].own++;
        else if (o === "hire") packages[pkg].hire++;
        else if (o === "nc") packages[pkg].nc++;
        packages[pkg].ehc += ehc;
        packages[pkg].ihc += ihc;
      }
    });

    const toCrore = val => {
      if (!val || isNaN(val)) return "₹ 0 Cr";
      const crore = val / 10000000;
      return "₹ " + crore.toFixed(2) + " Cr";
    };

    // ✅ Update totals
    document.getElementById("countOwn").innerText = own;
    document.getElementById("countHire").innerText = hire;
    document.getElementById("countNC").innerText = nc;
    document.getElementById("totalEHC").innerText = toCrore(totalEHC);
    document.getElementById("totalIHC").innerText = toCrore(totalIHC);

    // ✅ Update package cards
    document.getElementById("adabariOwn").innerText = packages.adabari.own;
    document.getElementById("adabariHire").innerText = packages.adabari.hire;
    document.getElementById("adabariNC").innerText = packages.adabari.nc;
    document.getElementById("adabariEHC").innerText = toCrore(packages.adabari.ehc);
    document.getElementById("adabariIHC").innerText = toCrore(packages.adabari.ihc);

    document.getElementById("birsingOwn").innerText = packages.birsing.own;
    document.getElementById("birsingHire").innerText = packages.birsing.hire;
    document.getElementById("birsingNC").innerText = packages.birsing.nc;
    document.getElementById("birsingEHC").innerText = toCrore(packages.birsing.ehc);
    document.getElementById("birsingIHC").innerText = toCrore(packages.birsing.ihc);

    document.getElementById("phulbariOwn").innerText = packages.phulbari.own;
    document.getElementById("phulbariHire").innerText = packages.phulbari.hire;
    document.getElementById("phulbariNC").innerText = packages.phulbari.nc;
    document.getElementById("phulbariEHC").innerText = toCrore(packages.phulbari.ehc);
    document.getElementById("phulbariIHC").innerText = toCrore(packages.phulbari.ihc);

    // 🕓 Update Last Updated timestamp
    const latest = data.reduce((acc, r) => {
      if (r.last_updated_at && (!acc || new Date(r.last_updated_at) > new Date(acc))) {
        return r.last_updated_at;
      }
      return acc;
    }, null);

    document.getElementById("lastUpdate").innerText = latest ? formatLocalDate(latest) : "--";
  }


  // Toggle Filters
  let filtersVisible = false;
  document.getElementById("toggleFiltersBtn").addEventListener("click", () => {
    filtersVisible = !filtersVisible;
    const container = document.getElementById("asset-table");
    if (filtersVisible) container.classList.add("filters-visible");
    else container.classList.remove("filters-visible");
  });

  // Search
  document.getElementById("globalSearchInput").addEventListener("input", e=>{
    const mode=document.querySelector("input[name='searchMode']:checked").value,q=e.target.value.toLowerCase();
    if(!q) table.clearFilter(); else table.setFilter(mode,"like",q);
    updateOwnerCounts();
  });
  document.getElementById("clearSearchBtn").addEventListener("click",()=>{
    document.getElementById("globalSearchInput").value="";
    table.clearFilter();
    updateOwnerCounts();
  });

  // Refresh
  document.getElementById("refreshBtn").addEventListener("click", loadData);

  // Bulk Delete
  document.getElementById("deleteSelectedBtn").addEventListener("click", () => {
    const selected = table.getSelectedData();
    if (!selected.length) { alert("No rows selected!"); return; }
    if (!confirm(`Delete ${selected.length} selected asset(s)?`)) return;
    const ids = selected.map(r => r.id);
    fetch("/admin/delete_assets_bulk", {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ids})
    }).then(r=>r.json()).then(resp=>{
      if(resp.success){
        loadData();
        showToast(`Deleted ${ids.length} assets`, "success");;
      } else {
        showToast("Bulk delete failed: " + (resp.error || "Unknown"), "error");
      }
          
    }).catch(err => showToast("Bulk delete error: " + err, "error"));
  });

  // CSV Upload with progress + loading overlay + toasts
  document.getElementById("csvUploadInput").addEventListener("change", e => {
    const file = e.target.files[0];
    if (!file) return;

    const wrapper = document.getElementById("uploadWrapper");
    const bar = document.getElementById("uploadProgress");
    const status = document.getElementById("uploadStatus");
    const input = e.target;

    wrapper.classList.remove("hidden");
    input.disabled = true;
    bar.style.width = "0%";
    bar.innerText = "";
    status.innerText = "Starting upload...";

    const xhr = new XMLHttpRequest();
    xhr.open("POST", "/admin/upload_assets_csv");

    showLoading(true);

    xhr.upload.onprogress = function (ev) {
      if (ev.lengthComputable) {
        const percent = (ev.loaded / ev.total) * 100;
        const uploaded = ev.loaded < 1024 ? `${ev.loaded} B` : `${(ev.loaded / 1024).toFixed(1)} KB`;
        const total = ev.total < 1024 ? `${ev.total} B` : `${(ev.total / 1024).toFixed(1)} KB`;
        bar.style.width = percent + "%";
        bar.innerText = `${Math.round(percent)}%`;
        status.innerText = `Uploading ${uploaded} / ${total}`;
      }
    };

    xhr.onload = function () {
      showLoading(false);
      try {
        const resp = JSON.parse(xhr.responseText || "{}");
        if (xhr.status === 200 && resp.success) {
          bar.style.width = "100%";
          bar.innerText = "100%";
          status.innerText = "✅ Upload completed";
          showToast(resp.message || "CSV uploaded successfully", "success");
          loadData();
        } else {
          status.innerText = "❌ " + (resp.error || "Upload failed");
          showToast("Upload failed: " + (resp.error || "Unknown"), "error");
          if (resp.details && resp.details.length) showErrorPopup(resp.details);
        }
      } catch (err) {
        status.innerText = "❌ Upload failed (invalid response)";
        showToast("Upload failed (invalid response)", "error");
      }

      setTimeout(() => {
        wrapper.classList.add("hidden");
        bar.innerText = "";
        input.disabled = false;
      }, 2500);
    };

    xhr.onerror = function () {
      showLoading(false);
      status.innerText = "❌ Upload error";
      showToast("Upload error — network or server problem", "error");
      setTimeout(() => {
        wrapper.classList.add("hidden");
        bar.innerText = "";
        input.disabled = false;
      }, 2500);
    };

    const fd = new FormData();
    fd.append("csv_file", file);
    xhr.send(fd);
    e.target.value = "";
  });

  function showErrorPopup(errors){
    const popup=document.getElementById("errorPopup"),list=document.getElementById("errorList");
    list.innerHTML="";
    errors.forEach(err=>{
      const li=document.createElement("li");
      li.textContent=err;
      list.appendChild(li);
    });
    popup.classList.remove("hidden");
    document.getElementById("downloadErrorCsv").onclick=()=>{
      const csvContent="data:text/csv;charset=utf-8,"+errors.map(e=>`"${e}"`).join("\n");
      const link=document.createElement("a");
      link.setAttribute("href",encodeURI(csvContent));
      link.setAttribute("download","upload_errors.csv");
      link.click();
    };
  }
  document.getElementById("closeErrorPopup").addEventListener("click",()=>{
    document.getElementById("errorPopup").classList.add("hidden");
  });

  // Excel
  document.getElementById("downloadExcelBtn").addEventListener("click",()=>{
    table.download("xlsx","asset_master.xlsx",{sheetName:"Assets"});
  });

  // Sync scroll
  const topScroll=document.getElementById("scrollTop"), bottomScroll=document.getElementById("scrollBottom");
  function syncScroll(e){
    if(e.target===topScroll) bottomScroll.scrollLeft=topScroll.scrollLeft;
    else topScroll.scrollLeft=bottomScroll.scrollLeft;
  }
  topScroll.addEventListener("scroll", syncScroll);
  bottomScroll.addEventListener("scroll", syncScroll);

  

  
    function openEditModal(rowData) {
    // ✅ Fill hidden ID field
    document.getElementById("edit_id").value = rowData.id || "";

    // ✅ All editable fields
    const fields = [
      "asset_code","asset_description","reg_no","package","activity","location","meter_type","uom",
      "fuel_norms","owner","vendor_code","agency","wod_number","vendor_mail_id","date_of_commission",
      "starting_reading","tank_capacity","hsd_available","make","model","pm_make","pm_model",
      "ehc","ihc","shift_hours","operator_available","helper_available",
      "supervisor_owner_name","supervisor_owner_phone","operator1","operator1_phone","operator1_shift",
      "operator2","operator2_phone","operator2_shift"
    ];

    fields.forEach((f) => {
      const el = document.getElementById("edit_" + f);
      if (el) el.value = rowData[f] ?? "";
    });

    document.getElementById("editModal").classList.remove("hidden");
  }


  table.on("dataLoaded", updateOwnerCounts);
  document.addEventListener("DOMContentLoaded", loadData);
</script>
{% endblock %}
