{% extends 'admin_base.html' %}
{% block title %}Add Asset{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto bg-white rounded-lg shadow p-6 mt-6">
  <h1 class="text-2xl font-bold text-gray-800 mb-6">Add New Asset</h1>

  <form id="addAssetForm" class="space-y-10">

    <!-- ----------------- ASSET DETAILS ----------------- -->
    <section>
      <h2 class="text-lg font-semibold mb-3 border-b pb-1 text-yellow-700">Asset Details</h2>
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
        <div>
          <label class="block text-sm mb-1">Asset Code</label>
          <input id="asset_code" name="asset_code" class="w-full border rounded px-3 py-2" required>
        </div>
        <div>
          <label class="block text-sm mb-1">Asset Description</label>
          <input id="asset_description" name="asset_description" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-sm mb-1">Asset Category</label>
          <select id="asset_category" name="asset_category" class="w-full border rounded px-3 py-2" required>
            <option value="">-- Select Category --</option>
            {% for cat in ["Concreting Eqpt","Cranes","EarthMoving Eqpt","Marine Eqpt","Material Handling Eqpt","Power Generators","Utility Eqpt","Vehicles - Cargo","Vehicles - Passenger"] %}
              <option value="{{ cat }}">{{ cat }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label class="block text-sm mb-1">Registration No.</label>
          <input id="reg_no" name="reg_no" class="w-full border rounded px-3 py-2">
        </div>
      </div>
    </section>

    <!-- ----------------- LOCATION & ACTIVITY ----------------- -->
    <section>
      <h2 class="text-lg font-semibold mb-3 border-b pb-1 text-yellow-700">Location & Activity</h2>
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
        <div>
          <label class="block text-sm mb-1">Package</label>
          <select id="package" name="package" class="w-full border rounded px-3 py-2">
            {% for p in ["Adabari","Birsing","Phulbari"] %}
              <option value="{{ p }}">{{ p }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label class="block text-sm mb-1">Activity</label>
          <select id="activity" name="activity" class="w-full border rounded px-3 py-2">
            {% for a in ["Batching Plant","LG","Fabrication","Civil Works","Bridge Builders","Pire Table","Upper Pylon","Marine","Well Works","Office / Accommodation / Admin","Enabling","Other Works"] %}
              <option value="{{ a }}">{{ a }}</option>
            {% endfor %}
          </select>
        </div>

        <div>
          <label>Activity Works</label>
          <input id="activity_works" name="activity_works"
          placeholder="Enter specific work description"
          class="w-full border rounded px-3 py-2" />
        </div>
        <div>
          <label class="block text-sm mb-1">Location</label>
          <input id="location" name="location" class="w-full border rounded px-3 py-2">
        </div>
      </div>
    </section>

    <!-- ----------------- OWNER / METER TYPE / FUEL ----------------- -->
    <section>
      <h2 class="text-lg font-semibold mb-3 border-b pb-1 text-yellow-700">Owner / Meter Type / Fuel Details</h2>
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
        <div>
          <label class="block text-sm mb-1">Meter Type</label>
          <select id="meter_type" name="meter_type" class="w-full border rounded px-3 py-2">
            {% for m in ["HMR","KMR","HMR/KMR"] %}
              <option value="{{ m }}">{{ m }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label class="block text-sm mb-1">UoM</label>
          <select id="uom" name="uom" class="w-full border rounded px-3 py-2">
            {% for u in ["KMPL","LPH","LPH/KMPL"] %}
              <option value="{{ u }}">{{ u }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label class="block text-sm mb-1">Fuel Norms</label>
          <input id="fuel_norms" name="fuel_norms" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-sm mb-1">Owner</label>
          <select id="owner" name="owner" class="w-full border rounded px-3 py-2">
            {% for o in ["Own","Hire","NC"] %}
              <option value="{{ o }}">{{ o }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
    </section>

    <!-- ----------------- VENDOR DETAILS ----------------- -->
    <section>
      <h2 class="text-lg font-semibold mb-3 border-b pb-1 text-yellow-700">Vendor Details</h2>
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
        {% for field,label in {
          "vendor_code":"Vendor Code","agency":"Agency","wod_number":"WOD Number",
          "vendor_mail_id":"Vendor Mail ID","starting_reading":"Starting Reading",
          "tank_capacity":"Tank Capacity","hsd_available":"HSD Available",
          "make":"Make","model":"Model","pm_make":"PM Make","pm_model":"PM Model"
        }.items() %}
        <div>
          <label class="block text-sm mb-1">{{ label }}</label>
          <input id="{{ field }}" name="{{ field }}" class="w-full border rounded px-3 py-2">
        </div>
        {% endfor %}
        <div>
          <label class="block text-sm mb-1">Date of Commission</label>
          <input type="date" id="date_of_commission" name="date_of_commission" class="w-full border rounded px-3 py-2" min="2021-01-01" max="2030-12-31">
        </div>
      </div>
    </section>

    <!-- ----------------- HIRE CHARGES ----------------- -->
    <section>
      <h2 class="text-lg font-semibold mb-3 border-b pb-1 text-yellow-700">Hire Charges</h2>
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
        <div>
          <label class="block text-sm mb-1">EHC</label>
          <input type="number" id="ehc" name="ehc" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-sm mb-1">IHC</label>
          <input type="number" id="ihc" name="ihc" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-sm mb-1">Shift Hours</label>
          <input type="number" id="shift_hours" name="shift_hours" class="w-full border rounded px-3 py-2">
        </div>
      </div>
    </section>

    <!-- ----------------- OPERATOR DETAILS ----------------- -->
    <section>
      <h2 class="text-lg font-semibold mb-3 border-b pb-1 text-yellow-700">Operator Details</h2>
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
        <div>
          <label class="block text-sm mb-1">Operators Available (0–4)</label>
          <input type="number" id="operator_available" name="operator_available" min="0" max="4" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-sm mb-1">Helpers Available (0–6)</label>
          <input type="number" id="helper_available" name="helper_available" min="0" max="6" class="w-full border rounded px-3 py-2">
        </div>

        {% for f,label in {
          "supervisor_owner_name":"Supervisor/Owner Name","supervisor_owner_phone":"Supervisor/Owner Phone",
          "operator1":"Operator 1","operator1_phone":"Operator 1 Phone",
          "operator2":"Operator 2","operator2_phone":"Operator 2 Phone"
        }.items() %}
        <div>
          <label class="block text-sm mb-1">{{ label }}</label>
          <input id="{{ f }}" name="{{ f }}" class="w-full border rounded px-3 py-2">
        </div>
        {% endfor %}

        <div>
          <label class="block text-sm mb-1">Operator 1 Shift</label>
          <select id="operator1_shift" name="operator1_shift" class="w-full border rounded px-3 py-2">
            <option value="">-- Select Shift --</option>
            <option value="Day">Day</option>
            <option value="Night">Night</option>
          </select>
        </div>
        <div>
          <label class="block text-sm mb-1">Operator 2 Shift</label>
          <select id="operator2_shift" name="operator2_shift" class="w-full border rounded px-3 py-2">
            <option value="">-- Select Shift --</option>
            <option value="Day">Day</option>
            <option value="Night">Night</option>
          </select>
        </div>
      </div>
    </section>

    <!-- Buttons -->
    <div class="flex justify-end gap-4 mt-8">
      <a href="/admin/admin_asset_master" class="px-4 py-2 rounded border bg-gray-200 hover:bg-gray-300 text-gray-800">Cancel</a>
      <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-5 py-2 rounded shadow">➕ Add Asset</button>
    </div>
  </form>
</div>

<script>
  document.getElementById("addAssetForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    const form = e.target;
    const data = {};

    Array.from(form.elements).forEach(el => {
      if (el.name) {
        if (el.type === "number") data[el.name] = el.value ? parseFloat(el.value) : null;
        else data[el.name] = el.value || null;
      }
    });

    data.last_updated_by = "{{ session.get('name','') }}";
    data.last_updated_at = new Date().toISOString();

    try {
      const r = await fetch("/admin/add_asset", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      });

      const resp = await r.json();

      if (r.status === 201 || resp.success) {
        alert("✅ Asset added successfully!");
        window.location.href = "/admin/admin_asset_master";
      } else {
        alert("❌ Failed to add asset: " + (resp.error || "Unknown error"));
      }
    } catch (err) {
      alert("❌ Error: " + err.message);
    }
  });
</script>
{% endblock %}
